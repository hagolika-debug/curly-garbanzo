name: Windows SSH Server

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  windows-ssh:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup OpenSSH Server
      shell: powershell
      run: |
        # Install OpenSSH Server if not present
        Write-Host "Installing OpenSSH Server..." -ForegroundColor Green
        Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
        
        # Start and configure SSH service
        Write-Host "Starting SSH service..." -ForegroundColor Green
        Start-Service sshd
        Set-Service -Name sshd -StartupType 'Automatic'
        
        # Confirm firewall rule exists (fixed error handling)
        Write-Host "Configuring firewall..." -ForegroundColor Green
        $firewallRule = Get-NetFirewallRule -Name "OpenSSH-Server-In-TCP" -ErrorAction SilentlyContinue
        if (!$firewallRule) {
          New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
          Write-Host "Firewall rule created" -ForegroundColor Green
        } else {
          Write-Host "Firewall rule already exists" -ForegroundColor Yellow
        }
    
    - name: Configure SSH Access
      shell: powershell
      run: |
        # Generate a random password
        $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%"
        $password = -join ((1..12) | ForEach {Get-Random -Maximum $chars.length | ForEach {$chars[$_]}})
        
        # Set password for current user
        $SecurePassword = ConvertTo-SecureString $password -AsPlainText -Force
        Set-LocalUser -Name $env:USERNAME -Password $SecurePassword
        
        # Store password in file and as output
        $password | Out-File -FilePath "$env:TEMP\ssh_password.txt"
        echo "SSH_PASSWORD=$password" >> $env:GITHUB_ENV
        
        # Enable password authentication in SSH config
        Write-Host "Configuring SSH settings..." -ForegroundColor Green
        $sshdConfigPath = "C:\ProgramData\ssh\sshd_config"
        
        # Backup original config
        Copy-Item $sshdConfigPath "$sshdConfigPath.bak"
        
        # Read config, modify and write back
        $config = Get-Content $sshdConfigPath
        $config = $config -replace '^#PasswordAuthentication yes', 'PasswordAuthentication yes'
        $config = $config -replace '^PasswordAuthentication no', 'PasswordAuthentication yes'
        $config | Set-Content $sshdConfigPath
        
        # Restart SSH service
        Restart-Service sshd
        Write-Host "SSH service restarted" -ForegroundColor Green
    
    - name: Get Connection Info
      shell: powershell
      run: |
        # Get public IP
        try {
          $ip = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10).Trim()
        } catch {
          $ip = "Unable to get public IP (check https://api.ipify.org manually)"
        }
        
        # Get local IPs for reference
        $localIPs = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}).IPAddress
        
        Write-Host "==========================================" -ForegroundColor Cyan
        Write-Host "‚úÖ SSH SERVER IS READY!" -ForegroundColor Green
        Write-Host "==========================================" -ForegroundColor Cyan
        Write-Host "üì° Public IP: $ip" -ForegroundColor Yellow
        Write-Host "üîå Port: 22" -ForegroundColor Yellow
        Write-Host "üë§ Username: $env:USERNAME" -ForegroundColor Yellow
        Write-Host "üîë Password: $env:SSH_PASSWORD" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "üìã Connection command:" -ForegroundColor White
        Write-Host "ssh $env:USERNAME@$ip" -ForegroundColor Green
        Write-Host ""
        Write-Host "üìã Local IPs (for internal network):" -ForegroundColor White
        $localIPs | ForEach-Object { Write-Host "   $_" -ForegroundColor Gray }
        Write-Host ""
        Write-Host "‚ö†Ô∏è  This runner will stay active for 6 hours max" -ForegroundColor Red
        Write-Host "==========================================" -ForegroundColor Cyan
        
        # Save info to file
        @"
SSH Server Information
=====================
Public IP: $ip
Port: 22
Username: $env:USERNAME
Password: $env:SSH_PASSWORD
Connection: ssh $env:USERNAME@$ip
"@ | Out-File -FilePath "$env:TEMP\ssh_info.txt"
    
    - name: Keep Runner Alive
      shell: powershell
      run: |
        Write-Host "üîÑ SSH server is running. Job will stay active for up to 6 hours." -ForegroundColor Yellow
        Write-Host "üìù Password is saved in: $env:TEMP\ssh_info.txt" -ForegroundColor Yellow
        Write-Host "üí° To stop early, cancel this workflow in GitHub Actions UI" -ForegroundColor Yellow
        Write-Host ""
        
        $counter = 0
        while ($true) {
          $counter++
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] SSH server active - Uptime: ${counter}h" -ForegroundColor Green
          Start-Sleep -Seconds 3600  # Wait 1 hour between updates
        }
