name: Windows SSH Server

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  windows-ssh:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup OpenSSH Server
      shell: pwsh
      run: |
        # Install OpenSSH Server if not present
        Write-Host "üì¶ Installing OpenSSH Server..." -ForegroundColor Green
        $sshInstall = Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
        Write-Host "Installation result: $($sshInstall.RestartNeeded)" -ForegroundColor Yellow
        
        # Start and configure SSH service
        Write-Host "üöÄ Starting SSH service..." -ForegroundColor Green
        Start-Service sshd
        Set-Service -Name sshd -StartupType 'Automatic'
        
        # Configure firewall rule with correct error handling
        Write-Host "üîí Configuring firewall..." -ForegroundColor Green
        $firewallRule = Get-NetFirewallRule -DisplayName "OpenSSH Server (sshd)" -ErrorAction SilentlyContinue
        if (-not $firewallRule) {
          New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' `
                              -DisplayName 'OpenSSH Server (sshd)' `
                              -Enabled True `
                              -Direction Inbound `
                              -Protocol TCP `
                              -Action Allow `
                              -LocalPort 22
          Write-Host "‚úÖ Firewall rule created" -ForegroundColor Green
        } else {
          Write-Host "‚úÖ Firewall rule already exists" -ForegroundColor Yellow
        }
    
    - name: Configure SSH Access
      shell: pwsh
      run: |
        # Generate a random password (special characters removed for compatibility)
        $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
        $password = -join ((1..12) | ForEach-Object { Get-Random -Minimum 0 -Maximum $chars.length | ForEach-Object { $chars[$_] } })
        
        # Set password for current user
        Write-Host "üîë Setting user password..." -ForegroundColor Green
        $SecurePassword = ConvertTo-SecureString $password -AsPlainText -Force
        Set-LocalUser -Name $env:USERNAME -Password $SecurePassword -ErrorAction Stop
        
        # Store password in environment variable
        echo "SSH_PASSWORD=$password" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
        # Enable password authentication in SSH config
        Write-Host "‚öôÔ∏è Configuring SSH settings..." -ForegroundColor Green
        $sshdConfigPath = "C:\ProgramData\ssh\sshd_config"
        
        # Check if config file exists
        if (Test-Path $sshdConfigPath) {
          # Backup original config
          Copy-Item $sshdConfigPath "$sshdConfigPath.bak" -Force
          
          # Read and modify config
          $config = Get-Content $sshdConfigPath
          $config = $config -replace '^#?\s*PasswordAuthentication\s+no', 'PasswordAuthentication yes'
          $config = $config -replace '^#?\s*PasswordAuthentication\s+yes', 'PasswordAuthentication yes'
          
          # Ensure the line exists
          $hasPasswordAuth = $config -match '^PasswordAuthentication\s+yes'
          if (-not $hasPasswordAuth) {
            $config += "`nPasswordAuthentication yes"
          }
          
          # Save modified config
          $config | Set-Content $sshdConfigPath -Force
          Write-Host "‚úÖ SSH configuration updated" -ForegroundColor Green
        } else {
          Write-Host "‚ö†Ô∏è SSH config not found at $sshdConfigPath" -ForegroundColor Red
          exit 1
        }
        
        # Restart SSH service
        Restart-Service sshd
        Write-Host "‚úÖ SSH service restarted" -ForegroundColor Green
        
        # Verify SSH is running
        $sshStatus = Get-Service sshd
        if ($sshStatus.Status -eq 'Running') {
          Write-Host "‚úÖ SSH service is running" -ForegroundColor Green
        } else {
          Write-Host "‚ùå SSH service failed to start" -ForegroundColor Red
          exit 1
        }
    
    - name: Get Connection Information
      shell: pwsh
      run: |
        Write-Host "`n" 
        Write-Host "=" * 50 -ForegroundColor Cyan
        Write-Host "üî∞ WINDOWS SSH SERVER IS READY" -ForegroundColor Green
        Write-Host "=" * 50 -ForegroundColor Cyan
        
        # Get public IP with multiple fallback options
        Write-Host "`nüì° Getting public IP address..." -ForegroundColor Yellow
        $publicIP = $null
        
        # Try multiple IP services
        $ipServices = @(
          "https://api.ipify.org",
          "https://icanhazip.com",
          "https://ifconfig.me/ip"
        )
        
        foreach ($service in $ipServices) {
          try {
            $publicIP = (Invoke-RestMethod -Uri $service -TimeoutSec 5).Trim()
            Write-Host "  ‚úÖ Got IP from $service" -ForegroundColor Green
            break
          } catch {
            Write-Host "  ‚ö†Ô∏è Failed to get IP from $service" -ForegroundColor Yellow
          }
        }
        
        if (-not $publicIP) {
          $publicIP = "Unable to determine public IP (check network manually)"
          Write-Host "  ‚ùå Could not determine public IP" -ForegroundColor Red
        }
        
        # Get local IP addresses
        $localIPs = Get-NetIPAddress -AddressFamily IPv4 | Where-Object { 
          $_.InterfaceAlias -notlike "*Loopback*" -and 
          $_.IPAddress -notlike "127.*" -and
          $_.AddressState -eq "Preferred"
        } | Select-Object -ExpandProperty IPAddress
        
        # Display connection information
        Write-Host "`nüìã CONNECTION DETAILS:" -ForegroundColor White
        Write-Host "  üåê Public IP: $publicIP" -ForegroundColor Yellow
        Write-Host "  üîå Port: 22" -ForegroundColor Yellow
        Write-Host "  üë§ Username: $env:USERNAME" -ForegroundColor Yellow
        Write-Host "  üîë Password: $env:SSH_PASSWORD" -ForegroundColor Yellow
        
        Write-Host "`nüíª CONNECTION COMMANDS:" -ForegroundColor White
        Write-Host "  ‚Ä¢ Standard SSH: ssh $env:USERNAME@$publicIP" -ForegroundColor Green
        Write-Host "  ‚Ä¢ With port: ssh -p 22 $env:USERNAME@$publicIP" -ForegroundColor Green
        
        if ($localIPs) {
          Write-Host "`nüè† LOCAL IP ADDRESSES (for same network):" -ForegroundColor White
          foreach ($localIP in $localIPs) {
            Write-Host "  ‚Ä¢ $localIP" -ForegroundColor Gray
          }
        }
        
        Write-Host "`n‚è±Ô∏è  SESSION INFORMATION:" -ForegroundColor White
        Write-Host "  ‚Ä¢ Max runtime: 6 hours" -ForegroundColor Magenta
        Write-Host "  ‚Ä¢ Started: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Magenta
        Write-Host "  ‚Ä¢ Will end: $(Get-Date).AddHours(6) 'yyyy-MM-dd HH:mm:ss'" -ForegroundColor Magenta
        
        Write-Host "`n‚ö†Ô∏è  IMPORTANT NOTES:" -ForegroundColor Red
        Write-Host "  ‚Ä¢ Save this password now! It won't be shown again: $env:SSH_PASSWORD" -ForegroundColor Yellow
        Write-Host "  ‚Ä¢ To stop early: Cancel this workflow in GitHub Actions" -ForegroundColor Yellow
        Write-Host "  ‚Ä¢ This is temporary - VM will be destroyed after job ends" -ForegroundColor Yellow
        
        Write-Host "`n" + ("=" * 50) -ForegroundColor Cyan
        
        # Save info to file for reference
        $infoContent = @"
WINDOWS SSH SERVER INFORMATION
==============================
Public IP: $publicIP
Port: 22
Username: $env:USERNAME
Password: $env:SSH_PASSWORD

Connection Command: ssh $env:USERNAME@$publicIP

Started: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
Expires: $(Get-Date).AddHours(6) 'yyyy-MM-dd HH:mm:ss'
"@
        $infoContent | Out-File -FilePath "$env:TEMP\ssh_server_info.txt" -Encoding utf8
        Write-Host "`nüìÅ Connection info saved to: $env:TEMP\ssh_server_info.txt" -ForegroundColor Gray
    
    - name: Keep Runner Alive
      shell: pwsh
      run: |
        Write-Host "`nüîÑ SSH SERVER IS NOW RUNNING" -ForegroundColor Green
        Write-Host "‚è≥ This job will stay active for up to 6 hours" -ForegroundColor Yellow
        Write-Host "üí° Press Ctrl+C in the runner to stop early (not recommended)" -ForegroundColor Yellow
        Write-Host ""
        
        $startTime = Get-Date
        $hoursElapsed = 0
        
        while ($hoursElapsed -lt 6) {
          $currentTime = Get-Date
          $elapsed = $currentTime - $startTime
          $hoursElapsed = [math]::Round($elapsed.TotalHours, 1)
          $minutesRemaining = [math]::Round(360 - $elapsed.TotalMinutes, 1)
          
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ‚úÖ SSH ACTIVE - Uptime: ${hoursElapsed}h - Remaining: ${minutesRemaining}m" -ForegroundColor Green
          
          # Test SSH service periodically
          $sshStatus = Get-Service sshd -ErrorAction SilentlyContinue
          if ($sshStatus.Status -ne 'Running') {
            Write-Host "‚ùå SSH service stopped! Attempting restart..." -ForegroundColor Red
            Start-Service sshd
          }
          
          Start-Sleep -Seconds 300  # Check every 5 minutes
        }
