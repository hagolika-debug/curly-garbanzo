name: SSH via Cloudflare
on: workflow_dispatch

jobs:
  ssh:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH Password
        run: |
          echo "runner:Pass1234" | sudo chpasswd
          # Enable Password Authentication in SSH config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Start Cloudflare Tunnel
        id: tunnel
        run: |
          # Start tunnel and log the output to a file to grab the URL
          nohup cloudflared tunnel --url tcp://localhost:22 > tunnel.log 2>&1 &
          sleep 10
          grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel.log | head -n 1 > url.txt
          echo "TUNNEL_URL=$(cat url.txt)" >> $GITHUB_ENV
          echo "Your SSH URL is: $(cat url.txt)"

      - name: Keep Alive
        run: |
          echo "------------------------------------------------------------"
          echo "CONNECT VIA HTTP CUSTOM USING:"
          echo "Host: ${{ env.TUNNEL_URL }}"
          echo "Port: 443 (Cloudflare uses 443 for the tunnel entry)"
          echo "User: runner"
          echo "Pass: Pass1234"
          echo "------------------------------------------------------------"
          sleep 21600
