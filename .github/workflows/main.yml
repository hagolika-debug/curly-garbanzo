name: SSH via Cloudflare (Auto Format)
on: workflow_dispatch

jobs:
  ssh-server:
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        run: |
          # Set the password
          echo "runner:Pass1234" | sudo chpasswd
          # Ensure SSH allows password login
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Tunnel and Format Output
        run: |
          # Start tunnel in background
          nohup cloudflared tunnel --url tcp://localhost:22 > tunnel.log 2>&1 &
          
          # Wait for the URL to generate
          sleep 12
          
          # Extract the hostname (removes https:// and any trailing slashes)
          RAW_URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel.log | head -n 1)
          CLEAN_HOST=$(echo $RAW_URL | sed 's/https:\/\///')
          
          echo "------------------------------------------------------------"
          echo "COPY AND PASTE INTO HTTP CUSTOM:"
          echo "------------------------------------------------------------"
          echo "$CLEAN_HOST:443@runner:Pass1234"
          echo "------------------------------------------------------------"
          
      - name: Keep Alive
        run: sleep 21600 # Keeps the server up for 6 hours
