name: Windows SSH Server

on:
  workflow_dispatch:  # Manual trigger
  # push:
  #   branches: [ main ]  # Optional: trigger on push

jobs:
  windows-ssh:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup OpenSSH Server
      shell: powershell
      run: |
        # Install OpenSSH Server if not present
        Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
        
        # Start and configure SSH service
        Start-Service sshd
        Set-Service -Name sshd -StartupType 'Automatic'
        
        # Confirm firewall rule exists
        if (!(Get-NetFirewallRule -Name "OpenSSH-Server-In-TCP" -ErrorAction SilentlyIgnore)) {
          New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
        }
    
    - name: Configure SSH Access
      shell: powershell
      run: |
        # Set password for current user (change 'YourPassword123!' to something secure)
        $Password = ConvertTo-SecureString "anasshed123!" -AsPlainText -Force
        Set-LocalUser -Name $env:USERNAME -Password $Password
        
        # Enable password authentication
        $sshdConfig = "C:\ProgramData\ssh\sshd_config"
        (Get-Content $sshdConfig) -replace '#PasswordAuthentication yes', 'PasswordAuthentication yes' | Set-Content $sshdConfig
        (Get-Content $sshdConfig) -replace 'PasswordAuthentication no', 'PasswordAuthentication yes' | Set-Content $sshdConfig
        
        # Restart SSH service
        Restart-Service sshd
    
    - name: Get Connection Info
      shell: powershell
      run: |
        $ip = (Invoke-RestMethod -Uri "https://api.ipify.org").Trim()
        echo "=========================================="
        echo "SSH SERVER READY"
        echo "=========================================="
        echo "IP Address: $ip"
        echo "Port: 22"
        echo "Username: $env:USERNAME"
        echo "Password: YourPassword123! (change this!)"
        echo ""
        echo "Connect with: ssh $env:USERNAME@$ip"
        echo "=========================================="
        
        # Keep runner alive (this will run for the job duration)
        echo "SSH server running. Job will stay active for up to 6 hours."
    
    - name: Keep Alive
      shell: powershell
      run: |
        # This keeps the runner active
        while ($true) {
          Start-Sleep -Seconds 3600
          Get-Date
        }
